version: '3.8'

services:
  # Redis with TimeSeries module
  redis:
    image: redis/redis-stack:latest
    container_name: cupcake-redis
    ports:
      - "6379:6379"
      - "8001:8001"  # RedisInsight web UI
    volumes:
      - redis_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    command: redis-server /usr/local/etc/redis/redis.conf
    environment:
      - REDIS_ARGS="--save 60 1000 --appendonly yes"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - cupcake-network

  # Main application
  cupcake-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cupcake-main
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - CUPCAKE_LOG_DIR=/app/logs
      - BUFFER_SIZE=600
      - OUTLIER_SIGMA=3.0
      - TZ=Asia/Kolkata
    volumes:
      - ./logs:/app/logs
      - ./authentication/credentials.json:/app/authentication/credentials.json:ro
      - app_data:/app/data
    ports:
      - "8080:8080"  # Web interface
    restart: unless-stopped
    networks:
      - cupcake-network
    healthcheck:
      test: ["CMD", "/app/docker-healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Historical data fetcher (separate service for modularity)
  cupcake-historical:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cupcake-historical
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - CUPCAKE_LOG_DIR=/app/logs
      - TZ=Asia/Kolkata
    volumes:
      - ./logs:/app/logs
      - ./authentication/credentials.json:/app/authentication/credentials.json:ro
    command: ["python", "scripts/historical_data_fetcher.py"]
    restart: "no"  # Run once
    networks:
      - cupcake-network
    profiles:
      - historical

  # Live data fetcher
  cupcake-live:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cupcake-live
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - CUPCAKE_LOG_DIR=/app/logs
      - TZ=Asia/Kolkata
    volumes:
      - ./logs:/app/logs
      - ./authentication/credentials.json:/app/authentication/credentials.json:ro
    command: ["python", "scripts/enhanced_live_data_fetcher.py"]
    restart: unless-stopped
    networks:
      - cupcake-network
    profiles:
      - live

  # WebSocket analytics engine
  cupcake-websocket:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cupcake-websocket
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=1  # Different DB for real-time data
      - CUPCAKE_LOG_DIR=/app/logs
      - BUFFER_SIZE=600
      - TZ=Asia/Kolkata
    volumes:
      - ./logs:/app/logs
      - ./authentication/credentials.json:/app/authentication/credentials.json:ro
    command: ["python", "scripts/websocket_client.py"]
    restart: unless-stopped
    networks:
      - cupcake-network
    profiles:
      - websocket

  # Monitoring and metrics
  cupcake-monitor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cupcake-monitor
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=1
      - TZ=Asia/Kolkata
    volumes:
      - ./logs:/app/logs
    command: ["/app/bash_scripts/redis_monitor_script.sh", "overview", "auto"]
    restart: unless-stopped
    networks:
      - cupcake-network
    profiles:
      - monitor

volumes:
  redis_data:
    driver: local
  app_data:
    driver: local

networks:
  cupcake-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16